Bootstrap: docker
From: pytorch/pytorch:1.9.0-cuda10.2-cudnn7-runtime

%labels
        MAINTAINER      JJ
%setup
    # will be installed and removed in post step
    cp ./src/Singularity_gpu_fix.sh $SINGULARITY_ROOTFS/

%environment
        PATH=$PATH:/usr/local/TGSA
        MODEL_DIR=/usr/local/TGDA_model
        CANDLE_DATA_DIR=/candle_data_dir

%post
    apt-get update
    apt-get install -y git
    apt-get install -y wget
    apt-get install -y gnupg
    #apt-key adv --keyserver keyserver.ubuntu.com --keyserver-options http-proxy=http://proxy.alcf.anl.gov:3128 --recv-keys F60F4B3D7FA2AF80
    #apt-key adv --keyserver keyserver.ubuntu.com --keyserver-options http-proxy=http://proxy.alcf.anl.gov:3128 --recv-keys A4B469963BF863CC
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys F60F4B3D7FA2AF80
    apt-key adv --keyserver keyserver.ubuntu.com --recv-keys A4B469963BF863CC
    #apt-get update
    #apt-get install -y git
    #apt-get install -y wget
    #apt-get install -y gnupg
    # install gpu fix and clean up
    cd /
    chmod +x Singularity_gpu_fix.sh
    ./Singularity_gpu_fix.sh
    rm Singularity_gpu_fix.sh

    # create default internal candle_data_dir, map external candle_data_dir here
    mkdir /candle_data_dir

    # install python modules and model prerequisites
    pip install git+https://github.com/ECP-CANDLE/candle_lib@develop


    # setup model and executables
    cd /usr/local/
    git clone -b develop https://github.com/smujiang/TGSA.git

    pip install torch-geometric==1.7.1
    wget https://data.pyg.org/whl/torch-1.6.0%2Bcu102/torch_cluster-1.5.7-cp38-cp38-linux_x86_64.whl
    wget https://data.pyg.org/whl/torch-1.6.0%2Bcu102/torch_scatter-2.0.5-cp38-cp38-linux_x86_64.whl
    wget https://data.pyg.org/whl/torch-1.6.0%2Bcu102/torch_sparse-0.6.8-cp38-cp38-linux_x86_64.whl
    wget https://data.pyg.org/whl/torch-1.6.0%2Bcu102/torch_spline_conv-1.2.1-cp38-cp38-linux_x86_64.whl


    conda env create -f TGSA/singularity/TGSA.yml
    conda activate /usr/local/envs/TGSA


    chmod +x TGSA/train.sh
    chmod +x TGSA/refer.sh
    chmod +x TGSA/preprocess.sh

